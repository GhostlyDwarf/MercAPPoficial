<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validación de Compras</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">Validación de Compras</h2>
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>IVA</th>
                    <th>Total con IVA</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for compra in compras %}
                <tr>
                    <td>{{ compra.cliente.nombre }} {{ compra.cliente.apellido }}</td>
                    <td>${{ compra.total }}</td>
                    <td>${{ compra.iva }}</td>
                    <td>${{ compra.total_con_iva }}</td>
                    <td>{{ compra.fecha_compra|date:"d/m/Y H:i" }}</td>
                    <td>
                        {% if compra.pagada %}
                        <span class="badge bg-success">Pagada</span>
                        {% else %}
                        <span class="badge bg-danger">No Pagada</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'detalle_compra' compra.id %}" class="btn btn-primary btn-sm">Ver Resumen</a>
                        {% if not compra.pagada %}
                        <button class="btn btn-success btn-sm marcar-pagada" data-id="{{ compra.id }}">Marcar como Pagada</button>
                        {% endif %}
                        {% if compra.pagada %}
                        <button class="btn btn-danger btn-sm marcar-no-pagada" data-id="{{ compra.id }}">Marcar como No Pagada</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No hay compras registradas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Manejar el botón "Marcar como Pagada"
        document.querySelectorAll('.marcar-pagada').forEach(button => {
            button.addEventListener('click', function () {
                const compraId = this.getAttribute('data-id');
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "¿Deseas marcar esta compra como pagada?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, marcar como pagada',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/marcar_pagada/${compraId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Actualizar el estado en el HTML
                                const row = button.closest('tr');
                                row.querySelector('.badge').classList.remove('bg-danger');
                                row.querySelector('.badge').classList.add('bg-success');
                                row.querySelector('.badge').textContent = 'Pagada';

                                // Cambiar los botones
                                button.remove(); // Eliminar el botón "Marcar como Pagada"
                                const accionesCell = row.querySelector('td:last-child');
                                const noPagadaButton = document.createElement('button');
                                noPagadaButton.className = 'btn btn-danger btn-sm marcar-no-pagada';
                                noPagadaButton.textContent = 'Marcar como No Pagada';
                                noPagadaButton.setAttribute('data-id', compraId);
                                accionesCell.appendChild(noPagadaButton);

                                // Agregar evento al nuevo botón
                                noPagadaButton.addEventListener('click', marcarNoPagada);

                                Swal.fire('¡Éxito!', data.message, 'success');
                            } else {
                                Swal.fire('Error', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            Swal.fire('Error', 'Ocurrió un error al procesar la solicitud.', 'error');
                        });
                    }
                });
            });
        });

        // Manejar el botón "Marcar como No Pagada"
        function marcarNoPagada(event) {
            const button = event.target;
            const compraId = button.getAttribute('data-id');
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas marcar esta compra como no pagada?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#28a745',
                confirmButtonText: 'Sí, marcar como no pagada',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/marcar_no_pagada/${compraId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Actualizar el estado en el HTML
                            const row = button.closest('tr');
                            row.querySelector('.badge').classList.remove('bg-success');
                            row.querySelector('.badge').classList.add('bg-danger');
                            row.querySelector('.badge').textContent = 'No Pagada';

                            // Cambiar los botones
                            button.remove(); // Eliminar el botón "Marcar como No Pagada"
                            const accionesCell = row.querySelector('td:last-child');
                            const pagadaButton = document.createElement('button');
                            pagadaButton.className = 'btn btn-success btn-sm marcar-pagada';
                            pagadaButton.textContent = 'Marcar como Pagada';
                            pagadaButton.setAttribute('data-id', compraId);
                            accionesCell.appendChild(pagadaButton);

                            // Agregar evento al nuevo botón
                            pagadaButton.addEventListener('click', function () {
                                button.click();
                            });

                            Swal.fire('¡Éxito!', data.message, 'success');
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Ocurrió un error al procesar la solicitud.', 'error');
                    });
                }
            });
        }

        document.querySelectorAll('.marcar-no-pagada').forEach(button => {
            button.addEventListener('click', marcarNoPagada);
        });
    });
</script>
</body>
</html>